<!DOCTYPE html>
<html>
    <head>
        <title>Home</title>
        <meta charset="utf-8">
        <link href="../css/stile-homepage.css" rel="stylesheet">
        <script src="https://kit.fontawesome.com/ec08f2a466.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
        <input type="checkbox" id="check">  
        <label for="check">
            <i class="fas fa-bars" id="btn"></i>
            <i class="fas fa-times" id="cancel"></i>
        </label>

        <div class="sidebar">
            <header>
                <br>
                <img class="user-logo" src="../images/userlogo.png" alt="userlogo">
                <p class="user-name-surname">Nome Cognome</p>
                <p class="user-email">user@domain.com</p>
            </header>
            <ul>
                <li><a href="#"><i class="fas fa-list-ul"></i>Ordini</a></li>
                <li><a href="homepage_produttore.html"><i class="fas fa-shopping-bag"></i>Prodotti</a></li>
                <li><a href="statistiche_produttore.html"><i class="fas fa-chart-bar"></i>Statistiche</a></li>
                <li><a href="#"><i class="fas fa-qrcode"></i>Scansione QR</a></li>
                <li><a href="../index.html"><i class="fas fa-sign-out-alt"></i>Logout</a></li>
            </ul>
        </div>

        <div class="top">
            <br>
            <input class="barraRicercaGenerale" type="text" placeholder="Ricerca Prodotti">
            <button class="button-refresh">Ricarica <i class="fa fa-refresh"></i></button>
            <br><br>
        </div>
        
        <div class="container">
            
            <a class="button" href="#" id="ricarica">
                <i class="fas fa-redo"></i> Reload
            </a>
        </div>
        <div class="container" id = "containerProdotti">
        </div>
        <script>
            //Ajax con jQuery, $ significa jQuery

            //Qui dichiaro una funzione che prende tutti i prodotti, verrà usata
            //quando carico la pagina per la prima volta e ogni volta che premo 
            //il bottone
            function prendiTuttiProdotti(data, status) {

                var containerProdotti = document.getElementById("containerProdotti");

                var divCategoria = document.createElement('div');
                divCategoria.className = "category";

                var titolo = document.createElement('h1');
                titolo.className = "category-name";

                titolo.appendChild(document.createTextNode("Prodotti"));
                divCategoria.appendChild(titolo);

                containerProdotti.appendChild(divCategoria);

                var listaProdotti = document.createElement('ul');
                listaProdotti.setAttribute("id", "listaprodotti");

                containerProdotti.appendChild(listaProdotti);

                for (var i = 0; i < data.length; i++) {

                    var listItem = document.createElement('li');

                    var divMain = document.createElement('div');
                    divMain.className = "main";

                    var divProduct = document.createElement('div');
                    divProduct.className = "product";

                    var img = document.createElement('img');
                    img.className = "image-product";
                    img.setAttribute("alt", "product image");
                    img.setAttribute("src", "../images/shrekkino.jpg")

                    var nomeProdotto = document.createElement('h1');
                    nomeProdotto.className = "product-name";
                    nomeProdotto.appendChild(document.createTextNode((data[i].nome)));

                    var indirizzo = document.createElement('p');
                    indirizzo.className = "address";
                    //indirizzo.appendChild(document.createTextNode((data[i].indirizzo)));

                    var prezzo = document.createElement('p');
                    prezzo.className = "price";
                    prezzo.appendChild(document.createTextNode((data[i].prezzo) + "€"));

                    divProduct.appendChild(document.createElement('br'));
                    divProduct.appendChild(img);
                    divProduct.appendChild(nomeProdotto);
                    var sommaQualitàPrezzo = 0;
                    for (let j = 0; j < data[i].recensioni.length; j++) {
                        sommaQualitàPrezzo += data[i].recensioni[j].qualitàPrezzo;
                        if (j === data[i].recensioni.length) { //Se sono arrivato all'ultimo
                            sommaQualitàPrezzo = Math.round(sommaQualitàPrezzo);
                            for (let k = 0; k < sommaQualitàPrezzo; k++) {
                                var tagI = document.createElement('i');
                                tagI.className = "fas fa-star";
                                divProduct.appendChild(tagI);
                            }
                        }
                    }
                    divProduct.appendChild(indirizzo);
                    divProduct.appendChild(prezzo);
                    divProduct.appendChild(document.createElement('br'));

                    divMain.appendChild(divProduct);
                    listItem.appendChild(divMain);
                    listaProdotti.appendChild(listItem);
                }

                var divNessunaRicerca = document.createElement('div');
                divNessunaRicerca.className = "nessunaricerca";
                divNessunaRicerca.appendChild(document.createTextNode("Nessun risultato"));

                containerProdotti.appendChild(divNessunaRicerca);
            }
            ;

            // N.B. la dicitura function dopo l'URL non è omissibile poiché
            //jQuery la converte nel suo codice. Per ovviare al problema di sdoppiare
            //il codice ho definito una funzione e la chiamo dentro function
            $(document).ready(function () {
                $.get("https://happyfarmer.herokuapp.com/prodotti", function (data, status) {
                    prendiTuttiProdotti(data, status);
                    $(".nessunaricerca").hide();
                });
            });

            //Ricarica dinamica dei prodotti quando premo il pulsante.
            //Prima svuoto e poi richiamo la get.
            //Fare css.
            $(document).ready(function () {
                $(".button-refresh").click(function () {
                    $.get("https://happyfarmer.herokuapp.com/prodotti", function (data, status) {
                        $("#containerProdotti").empty();
                        prendiTuttiProdotti(data, status);
                        $(".nessunaricerca").hide();
                    });
                });
            });

            $(document).ready(function () {
                $(".nessunaricerca").hide()
                $(".barraRicercaGenerale").keyup(function () {

                    //Prendo la stringa dalla barra e la inserisco in una variabile e
                    //imposto un contatore di supporto.
                    //Il contatore mi serve solo per mostrare una risposta in caso di mancata corrispondenza
                    var filtro = $(this).val(), contatore = 0;

                    if (contatore == 0) {
                        $(".nessunaricerca").hide()
                    }

                    //Ciclo all'interno della lista per ogni <li>
                    $("#listaprodotti li").each(function () {
                        //Se in questo <li> non è presente il testo allora lo nascondo
                        //RegExp prende il pattern filtro e esegue una ricerca,
                        //significa insensitive
                        if ($(this).text().search(new RegExp(filtro, "i")) < 0) {
                            $(this).hide() //Qui viene nascosto
                            if (contatore == 0) { //Se non c'è più nulla e il contatore è a 0 allora non ho trovato nulla
                                $(".nessunaricerca").show()
                            } else {    //Può essere che prima abbia trovato qualcosa quindi se il contatore è > 0 allora nascondo il meessaggio
                                $(".nessunaricerca").hide()
                            }
                        } else {
                            $(this).show(); //Qui è presente il pattern quindi lo mostro
                            contatore++; //Aumento il contatore per tenermi a memoria che qualcosa l'ho trovato ad un certo punto
                        }
                    });
                });
            });

        </script>
    </body>
</html>
